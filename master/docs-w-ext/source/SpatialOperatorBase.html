<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2018-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-button-SpatialOperatorBase'>/**
</span> * Spatial Operator Base Button
 *
 * @class BasiGX.view.button.SpatialOperatorBase
 */
Ext.define(&#39;BasiGX.view.button.SpatialOperatorBase&#39;, {
    extend: &#39;BasiGX.view.button.Base&#39;,
    xtype: &#39;basigx-button-spatial-operator-base&#39;,

    requires: [
    ],

<span id='BasiGX-view-button-SpatialOperatorBase-property-viewModel'>    /**
</span>     *
     */
    viewModel: {
        data: {
            invalidResultGeometryText: &#39;The process returned an invalid &#39; +
                &#39;geometry. Please try again&#39;,
            noValidOrNotEnoughGeometriesSelectedText: &#39;Please select at &#39; +
                &#39;least 2 valid objects&#39;,
            tooManyFeaturesSelectedText: &#39;Please select {0} objects as &#39; +
                &#39;maximum. If you want to edit more objects, repeat the &#39; +
                &#39;operation in multiple steps&#39;,
            masterSlaveFeatureDialogTitle: &#39;Select objects&#39;,
            firstFeatureNameInGrid: &#39;Object 1&#39;,
            secondFeatureNameInGrid: &#39;Object 2&#39;,
            firstGridTitle: &#39;Object to be edited&#39;,
            secondGridTitle: &#39;Helper object&#39;,
            gridDescriptionText: &#39;The objects geometry on the left side will &#39; +
                &#39;be edited. The object on the right side will remain &#39; +
                &#39;untouched. Drag and drop objects to switch their assignment&#39;,
            startOperationFromGridText: &#39;Start operation&#39;,
            invalidGridSelectionText: &#39;Invalid selection&#39;
        }
    },

<span id='BasiGX-view-button-SpatialOperatorBase-property-'>    /**
</span>     *
     */
    // bind: {
    //     text: &#39;{copyObjectBtnText}&#39;
    // },

    config: {
<span id='BasiGX-view-button-SpatialOperatorBase-cfg-selectionVectorLayer'>        /**
</span>         * Reference to the selectionVectorLayer
         */
        selectionVectorLayer: null,

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-targetVectorLayer'>        /**
</span>         * Reference to the targetVectorLayer
         */
        targetVectorLayer: null,

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-removeSelectedGeometriesAfterOperation'>        /**
</span>         * if set to true, the selected geometries for the spatial operation
         * will be removed after the operation, as a new one is derived
         */
        removeSelectedGeometriesAfterOperation: true,

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-copyAttributesFromFirstSelectedFeature'>        /**
</span>         * copy the attributes of the first selected feature if set to true
         */
        copyAttributesFromFirstSelectedFeature: true,

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-maxAllowedFeaturesForOperation'>        /**
</span>         * the number of features which are allowed to process together.
         * Union may use a high number without problems,
         * intersect will be restricted to 2
         */
        maxAllowedFeaturesForOperation: 2,

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-featureArray'>        /**
</span>         * an array containing the geometries that should be processed
         */
        featureArray: [],

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-showSelectMasterSlaveFeatureDialog'>        /**
</span>         * a boolean to indicate that a dialog window should be shown which
         * gives the user the opportunity to select which feature should be
         * used as master and which one as slave for the spatial operation
         */
        showSelectMasterSlaveFeatureDialog: false
    },

<span id='BasiGX-view-button-SpatialOperatorBase-cfg-listeners'>    listeners: {
</span>        click: function() {
            this.doProcess();
        }
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-doProcess'>    /**
</span>     * Main method starting the spatial operation after validating the input
     */
    doProcess: function() {
        var me = this;
        if (!me.getSelectionVectorLayer()) {
            Ext.log.error(&#39;No selection layer given, aborting&#39;);
            return;
        }

        // push the selected features from the select control
        Ext.each(me.selectionVectorLayer.getSource().
            getFeatures(), function(feature) {
            me.getFeatureArray().push(feature);
        });

        if (me.getFeatureArray().length &gt;
            me.getMaxAllowedFeaturesForOperation()) {
            BasiGX.util.MsgBox.error(Ext.String.format(
                me.getViewModel().get(&#39;tooManyFeaturesSelectedText&#39;),
                me.getMaxAllowedFeaturesForOperation()));
            me.setFeatureArray([]);
        } else if (me.getFeatureArray().length &gt;= 2) {
            // check if we have to display a dialog window for processing
            if (me.getShowSelectMasterSlaveFeatureDialog()) {
                me.createSelectMasterSlaveFeatureDialog(me.getFeatureArray());
            } else {
                // do the spatial operation directly
                var newFeature = me.processSelectedGeometries(
                    me.getFeatureArray());
                me.handleOperationResult(newFeature);
            }
        } else {
            BasiGX.util.MsgBox.error(
                me.getViewModel().get(
                    &#39;noValidOrNotEnoughGeometriesSelectedText&#39;));
            me.setFeatureArray([]);
        }
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-handleOperationResult'>    /**
</span>     * Method used on callback after spatial operation
     *
     * @param {ol.Feature|ol.Feature[]} newFeatures The feature generated by the
     * spatial operation
     */
    handleOperationResult: function(newFeatures) {
        var me = this;
        // check for valid geometry
        if (!newFeatures) {
            BasiGX.util.MsgBox.error(
                me.getViewModel().get(&#39;invalidResultGeometryText&#39;));
            me.cleanup();
            return;
        }
        if (!Ext.isArray(newFeatures)) {
            newFeatures = [newFeatures];
        }
        // copy the attributes from the first selected feature to the
        // new target feature
        if (me.getCopyAttributesFromFirstSelectedFeature()) {
            Ext.each(newFeatures, function(newFeature) {
                me.copyAttributes(newFeature);
            });
        }
        // add the new feature to the layer
        me.addFeaturesToTargetVectorLayer(newFeatures);
        // remove original geometries after operation
        if (me.getRemoveSelectedGeometriesAfterOperation()) {
            me.removeOriginalOperationFeatures();
        }
        me.cleanup();
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-cleanup'>    /**
</span>     * Resets the selections and highlights after processing
     */
    cleanup: function() {
        var me = this;
        // reset the geometries Array
        me.setFeatureArray([]);
        // cleanup selections
        if (me.getSelectionVectorLayer()) {
            me.getSelectionVectorLayer().getSource().clear();
        }
        // cleanup highlight features
        if (me.highLightLayer) {
            me.highLightLayer.getSource().clear();
        }
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-createSelectMasterSlaveFeatureDialog'>    /**
</span>     * Creates an `Ext.window.Window` to offer the user the option to select
     * which features shall be used in which way during the spatial operation
     *
     * @param {ol.Feature[]} featureArray The array of features to use
     */
    createSelectMasterSlaveFeatureDialog: function(featureArray) {
        var me = this;

        // setting the displayname for the features
        featureArray[0].displayName = me.getViewModel().get(
            &#39;firstFeatureNameInGrid&#39;);
        featureArray[1].displayName = me.getViewModel().get(
            &#39;secondFeatureNameInGrid&#39;);

        var masterGridStore = Ext.create(&#39;Ext.data.Store&#39;, {
            fields: [&#39;displayName&#39;],
            data: [featureArray[0]]
        });

        var masterGrid = Ext.create(&#39;Ext.grid.Panel&#39;, {
            viewConfig: {
                plugins: {
                    ptype: &#39;gridviewdragdrop&#39;,
                    dragGroup: &#39;masterGridDDGroup&#39;,
                    dropGroup: &#39;slaveGridDDGroup&#39;
                },
                listeners: {
                    itemmouseenter: function(scope, record) {
                        me.highlightFeature(record.data);
                    }
                }
            },
            store: masterGridStore,
            columns: [
                {
                    text: me.getViewModel().get(&#39;firstGridTitle&#39;),
                    flex: 1,
                    sortable: true,
                    dataIndex: &#39;displayName&#39;
                }
            ],
            margins: &#39;0 2 0 0&#39;
        });

        var slaveGridStore = Ext.create(&#39;Ext.data.Store&#39;, {
            fields: [&#39;displayName&#39;],
            data: [featureArray[1]]
        });

        var slaveGrid = Ext.create(&#39;Ext.grid.Panel&#39;, {
            viewConfig: {
                plugins: {
                    ptype: &#39;gridviewdragdrop&#39;,
                    dragGroup: &#39;slaveGridDDGroup&#39;,
                    dropGroup: &#39;masterGridDDGroup&#39;
                },
                listeners: {
                    itemmouseenter: function(scope, record) {
                        me.highlightFeature(record.data);
                    }
                }
            },
            store: slaveGridStore,
            columns: [
                {
                    text: me.getViewModel().get(&#39;secondGridTitle&#39;),
                    flex: 1,
                    sortable: true,
                    dataIndex: &#39;displayName&#39;
                }
            ],
            margins: &#39;0 0 0 2&#39;
        });

        Ext.create(&#39;Ext.window.Window&#39;, {
            title: me.getViewModel().get(&#39;masterSlaveFeatureDialogTitle&#39;),
            name: &#39;masterslavefeaturedialogwin&#39;,
            width: 450,
            height: 220,
            items: [
                {
                    xtype: &#39;panel&#39;,
                    border: false,
                    bodyPadding: 5,
                    items: [
                        {
                            xtype: &#39;displayfield&#39;,
                            value: me.getViewModel().get(&#39;gridDescriptionText&#39;)
                        }
                    ]
                },
                {
                    xtype: &#39;panel&#39;,
                    height: 100,
                    border: false,
                    layout: {
                        type: &#39;hbox&#39;,
                        align: &#39;stretch&#39;,
                        padding: 5
                    },
                    defaults: {
                        flex: 1
                    },
                    items: [
                        masterGrid,
                        slaveGrid
                    ]
                }
            ],
            buttons: [{
                text: me.getViewModel().get(&#39;startOperationFromGridText&#39;),
                handler: function(btn) {
                    //check if at least one feature is on every side
                    if (masterGridStore.getCount() &gt;= 1 &amp;&amp;
                        slaveGridStore.getCount() &gt;= 1) {
                        // reset the featurearray and reorder it
                        me.setFeatureArray([]);
                        var masterFeature = masterGridStore.getAt(0).data;
                        var slaveFeature = slaveGridStore.getAt(0).data;

                        // mark the second feature to stay after processing
                        slaveFeature.keepFeature = true;

                        me.getFeatureArray().push(masterFeature);
                        me.getFeatureArray().push(slaveFeature);

                        var newFeature = me.processSelectedGeometries(
                            me.getFeatureArray());

                        btn.up(&#39;window[name=masterslavefeaturedialogwin]&#39;).
                            destroy();
                        me.handleOperationResult(newFeature);
                    } else {
                        BasiGX.util.MsgBox.error(me.getViewModel().get(
                            &#39;invalidGridSelectionText&#39;));
                    }
                }
            }],
            listeners: {
                // remove all hovered features on window close
                &#39;close&#39;: function() {
                    if (me.highLightLayer) {
                        me.highLightLayer.getSource().clear();
                    }
                    me.setFeatureArray([]);
                }
            }
        }).showAt(0);
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-addFeaturesToTargetVectorLayer'>    /**
</span>     * Adds the newly generated features to the targetVectorLayer
     *
     * @param {ol.Feature[]} features The features to add
     */
    addFeaturesToTargetVectorLayer: function(features) {
        var me = this;
        if (me.getTargetVectorLayer()) {
            me.getTargetVectorLayer().getSource().addFeatures(features);
        }
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-removeOriginalOperationFeatures'>    /**
</span>     * Remove original features after the operation
     */
    removeOriginalOperationFeatures: function() {
        var me = this;
        var layer = me.getTargetVectorLayer();
        if (!layer) {
            return;
        }
        Ext.each(me.getFeatureArray(), function(feature) {
            if (feature.keepFeature) {
                return;
            }
            var match = false;
            Ext.each(layer.getSource().getFeatures(), function(feat) {
                if (feature === feat) {
                    match = true;
                    return false;
                }
            });
            if (match) {
                layer.getSource().removeFeature(feature);
            } else {
                Ext.log.warn(&#39;Could not remove an original feature, as the &#39; +
                    &#39;target and source layer seem to differ&#39;);
            }
        });
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-copyAttributes'>    /**
</span>     * Copy the attributes of the first selected feature
     * to the new target feature
     *
     * @param {ol.Feature} targetFeature The feature that shall receive
     *     the new attributes
     * @return {ol.Feature} The final feature
     */
    copyAttributes: function(targetFeature) {
        var me = this;
        var firstFeature = me.getFeatureArray()[0];
        Ext.iterate(firstFeature.getProperties(), function(key, val) {
            if (key.toLowerCase() !== &#39;fid&#39; &amp;&amp;
                key.toLowerCase() !== &#39;id&#39; &amp;&amp;
                key.toLowerCase() !== &#39;geometry&#39;) {
                // var prop = {};
                // prop[key] = val;
                // targetFeature.setProperties(prop);
                targetFeature.set(key, val);
            }
        });
        return targetFeature;
    },

<span id='BasiGX-view-button-SpatialOperatorBase-method-highlightFeature'>    /**
</span>     * Highlights a feature
     * @param {ol.Feature} feature The feature to highlight
     */
    highlightFeature: function(feature) {
        if (!this.highLightLayer) {
            this.highLightLayer = new ol.layer.Vector({
                source: new ol.source.Vector(),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: [255, 255, 0, 1],
                        width: 5
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: [255, 255, 0, 1]
                        })
                    })
                })
            });
            var displayInLayerSwitcherKey =
                BasiGX.util.Layer.KEY_DISPLAY_IN_LAYERSWITCHER;
            this.highLightLayer.set(displayInLayerSwitcherKey, false);
            var map = BasiGX.util.Map.getMapComponent().map;
            map.addLayer(this.highLightLayer);
        }
        this.highLightLayer.getSource().clear();
        this.highLightLayer.getSource().addFeatures([feature]);
    }
});
</pre>
</body>
</html>
