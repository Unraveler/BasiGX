<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2016-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-combo-Language'>/**
</span> * Combo for changing the language of a BasiGX based application out of a list
 * of predefined languages on-the-fly.
 *
 * **Basic usage:**
 *
 *     {
 *         xtype: &#39;basigx-combo-language&#39;
 *     }
 *
 * The config object of this component can be adapted to the surrounding
 * environment, where you want to set the preselected language, available
 * languages and the path template to the language files.
 *
 * **Real world usage:**
 *
 *     {
 *         xtype: &#39;basigx-combo-language&#39;,
 *         config: {
 *             defaultLanguage: &#39;en&#39;,
 *             languages: [{
 *                 code: &#39;de&#39;,
 *                 name: &#39;DE&#39;
 *             }, {
 *                 code: &#39;en&#39;,
 *                 name: &#39;EN&#39;
 *             }],
 *             appLocaleUrlTpl: &#39;./resources/locale/app-locale-{0}.json&#39;
 *         }
 *     }
 *
 * **Important:** The language file must be a valid JSON file following the
 * syntax stated below (Remove the comments in your language file):
 *
 *     {
 *         // full class name of the component
 *         &quot;BasiGX.view.button.AddWms&quot;: {
 *             &quot;config&quot;: {
 *                 // the viewModel object containing the language strings
 *                 &quot;data&quot;: {
 *                     &quot;tooltip&quot;: &quot;Open Add-WMS tool&quot;,
 *                     &quot;text&quot;: &quot;WMS&quot;,
 *                     &quot;windowTitle&quot;: &quot;Add WMS&quot;
 *                 }
 *             }
 *         }
 *     }
 *
 * The file must be named as configured in the appLocaleUrlTpl config, where
 * the placeholder `{0}` is to be replaced with the language code given in the
 * languages config, e.g. app-locale-en.json.
 *
 * @class BasiGX.view.combo.Language
 */
Ext.define(&#39;BasiGX.view.combo.Language&#39;, {
    extend: &#39;Ext.form.field.ComboBox&#39;,
    xtype: &#39;basigx-combo-language&#39;,
    requires: [
        &#39;BasiGX.util.Accessibility&#39;
    ],

<span id='BasiGX-view-combo-Language-cfg-viewModel'>    viewModel: {
</span>        data: {
            fieldLabel: null,
            documentation: &#39;&lt;h2&gt;Sprachauswahl&lt;/h2&gt;• Wählen Sie mit Hilfe &#39; +
                &#39;dieser ComboBox die Sprache der Anwendung aus.&lt;br&gt;• Nachdem &#39; +
                &#39;Sie eine andere Sprache gewählt haben, wird die Anwendung &#39; +
                &#39;in der entsprechenden Sprache dargestellt&#39;
        }
    },

<span id='BasiGX-view-combo-Language-cfg-bind'>    bind: {
</span>        fieldLabel: &#39;{fieldLabel}&#39;
    },

<span id='BasiGX-view-combo-Language-property-fields'>    /**
</span>     *
     */
    fields: [&#39;code&#39;, &#39;name&#39;],

<span id='BasiGX-view-combo-Language-property-queryMode'>    /**
</span>     *
     */
    queryMode: &#39;local&#39;,

<span id='BasiGX-view-combo-Language-property-displayField'>    /**
</span>     *
     */
    displayField: &#39;name&#39;,

<span id='BasiGX-view-combo-Language-property-valueField'>    /**
</span>     *
     */
    valueField: &#39;code&#39;,

<span id='BasiGX-view-combo-Language-property-autoSelect'>    /**
</span>     *
     */
    autoSelect: true,

<span id='BasiGX-view-combo-Language-property-forceSelection'>    /**
</span>     *
     */
    forceSelection: true,

<span id='BasiGX-view-combo-Language-property-editable'>    /**
</span>     *
     */
    editable: false,

<span id='BasiGX-view-combo-Language-property-grow'>    /**
</span>     *
     */
    grow: true,

<span id='BasiGX-view-combo-Language-property-privates'>    /**
</span>     *
     */
    privates: {
        locale: null
    },

<span id='BasiGX-view-combo-Language-property-config'>    /**
</span>     *
     */
    config: {
<span id='BasiGX-view-combo-Language-cfg-defaultLanguage'>        defaultLanguage: &#39;de&#39;,
</span><span id='BasiGX-view-combo-Language-cfg-languages'>        languages: [{
</span>            code: &#39;de&#39;,
            name: &#39;DE&#39;
        }, {
            code: &#39;en&#39;,
            name: &#39;EN&#39;
        }, {
            code: &#39;fr&#39;,
            name: &#39;FR&#39;
        }],
<span id='BasiGX-view-combo-Language-cfg-appLocaleUrlTpl'>        appLocaleUrlTpl: &#39;./resources/locale/app-locale-{0}.json&#39;
</span>    },

<span id='BasiGX-view-combo-Language-method-initComponent'>    /**
</span>     *
     */
    initComponent: function() {
        var me = this;

        // set the the config according to any given config option
        me.setConfig(me.config);

        me.store = Ext.create(&#39;Ext.data.Store&#39;, {
            sorters: [{
                property: &#39;code&#39;,
                direction: &#39;DESC&#39;
            }],
            data: me.getLanguages()
        });

        me.callParent(arguments);

        me.on({
            change: me.onLanguageChange
        });

        var defaultLanguage = me.getDefaultLanguage();
        me.setValue(defaultLanguage);
        BasiGX.util.Accessibility.setHtmlLanguage(defaultLanguage);
    },

<span id='BasiGX-view-combo-Language-method-onLanguageChange'>    /**
</span>     * Bound on the change event of the combo, this method will request the new
     * language file and trigger the translation of UI components.
     *
     * @param {Ext.form.field.ComboBox} combo The combo box.
     * @param {String} newValue The newly selected language.
     */
    onLanguageChange: function(combo, newValue) {
        var me = this;
        if (!Ext.isEmpty(newValue)) {
            me.requestLanguageFile(newValue);
        }
    },

<span id='BasiGX-view-combo-Language-method-requestLanguageFile'>    /**
</span>     * @param {String} locale The locale identifier of the selected language.
     */
    requestLanguageFile: function(locale) {
        var me = this;
        var appLocaleUrl = Ext.util.Format.format(
            me.getAppLocaleUrlTpl(), locale);

        me.locale = locale;

        Ext.Ajax.request({
            method: &#39;GET&#39;,
            url: appLocaleUrl,
            success: me.onLoadAppLocaleSuccess,
            failure: me.onLoadAppLocaleFailure,
            scope: me
        });
    },

<span id='BasiGX-view-combo-Language-method-onLoadAppLocaleSuccess'>    /**
</span>     * Called after we have received the response of the language file, this
     * method calls into #setAppLanguage, to actually translate the application.
     *
     * @param {Object} resp The response of the AJAX call for the language file.
     * @return {Boolean|undefined} Will return `false` in case of an error,
     *     and `undefined` otherwise.
     */
    onLoadAppLocaleSuccess: function(resp) {
        var me = this;
        var respObj;

        if (resp &amp;&amp; resp.responseText) {

            // try to parse the given string as JSON
            try {
                respObj = Ext.decode(resp.responseText);
                Ext.Logger.info(&#39;Succesfully loaded i18n file: &#39; + me.locale);
            } catch (err) {
                me.onLoadAppLocaleFailure();
                return false;
            } finally {
                if (respObj) {
                    me.setAppLanguage(respObj);
                    BasiGX.util.Accessibility.setHtmlLanguage(me.locale);
                    me.recreateSingletons();
                }
            }
        }
    },

<span id='BasiGX-view-combo-Language-method-onLoadAppLocaleFailure'>    /**
</span>     *
     */
    onLoadAppLocaleFailure: function() {
        var me = this;
        var defaultLanguage = me.getDefaultLanguage();

        if (me.locale === defaultLanguage) {
            me.erroneousTryToLoadDefaultLanguage = true;
        }

        // load default language, but try only once to prevent killswitch
        if (!me.erroneousTryToLoadDefaultLanguage) {
            Ext.Logger.warn(&#39;Error on loading the selected i18n file! Will &#39; +
                    &#39;try to load the default language &#39; + defaultLanguage +
                    &#39; instead.&#39;);
            me.requestLanguageFile(defaultLanguage);
        } else {
            Ext.Logger.error(&#39;٩(͡๏̯͡๏)۶ Could neither load the selected nor &#39; +
                    &#39;the fallback i18n file! Bad front-end behaviour is to &#39; +
                    &#39;be expected.&#39;);
        }
    },

<span id='BasiGX-view-combo-Language-method-setAppLanguage'>    /**
</span>     * Translates the application according to the passed `localeObj`.
     *
     * @param {Object} localeObj An object with locale data. The key is usually
     *     class name, and the value is an object which we can use for
     *     `Ext.define({override: &#39;classname&#39;});`
     */
    setAppLanguage: function(localeObj) {
        var me = this;
        var cq = Ext.ComponentQuery.query;
        var cqTpl = &#39;{self.getName() === &quot;{0}&quot;}{getViewModel()}&#39;;
        var instantiatedClasses;
        var baseLocaleObj;

        Ext.iterate(localeObj, function(className, locale) {
            baseLocaleObj = {
                override: className
            };

            Ext.iterate(locale, function(key, value) {
                baseLocaleObj[key] = value;
            });

            // 1. override the class itself
            Ext.define(className + &#39;.locale.&#39; + me.locale, baseLocaleObj);

            // 2. Now we will handle the classes viewmodel, if exisiting.
            // The override has to be based on the unmodified classname in
            // this case
            var currentClass = Ext.ClassManager.get(className);
            if (currentClass &amp;&amp; currentClass.getConfigurator) {
                var configurator = currentClass.getConfigurator();
                if (configurator &amp;&amp; configurator.values &amp;&amp;
                    configurator.values.viewModel) {
                    var viewModel = configurator.values.viewModel;
                    var type = viewModel.type;
                    // if the component has an own viewModel instance
                    if (!Ext.isEmpty(type) || Ext.isString(viewModel)) {
                        var viewName = type || viewModel;
                        var viewClassName = Ext.ClassManager.getName(
                            Ext.ClassManager
                                .getByAlias(&#39;viewmodel.&#39; + viewName));
                        baseLocaleObj.override = viewClassName;
                        Ext.define(viewClassName, baseLocaleObj);
                    } else if (!Ext.isEmpty(viewModel)) {
                        // if the component has an inline viewModel
                        Ext.apply(viewModel.data, locale.config.data);
                    }
                }
            }

            // 3. override the classes already instantiated
            // get all instantiated classes (containing a view model)
            instantiatedClasses = cq(Ext.String.format(cqTpl, className));
            // set the locale for each class
            Ext.each(instantiatedClasses, function(clazz) {
                // Check if the locale contains an expected structure…
                if (&#39;config&#39; in locale &amp;&amp; &#39;data&#39; in locale.config) {
                    clazz.getViewModel().setData(locale.config.data);
                }
                // … and don&#39;t do anything if it doesn&#39;t. This is not
                // technically an error, or sth. we should warn the user about.
                // Consider the following: A specific button class (with a
                // viewModel and a controller) opens an `Ext.window.Window`, and
                // wants to have the title come from the `viewModel` of the
                // button:
                // Ext.create(&#39;Ext.window.Window&#39;, {
                //     viewModel: myBtnViewModel, // a real instance of the vm
                //     bind: {
                //         title: &#39;{myWinTitle}&#39; // defined key in btn viewmodel
                //     }
                //     // other win properties
                // });
                // With this setup, the translation will work as long as the
                // button is visible / instantiated.
            });
        });
    },

<span id='BasiGX-view-combo-Language-method-recreateSingletons'>    /**
</span>     *
     */
    recreateSingletons: function() {
        Ext.MessageBox = Ext.Msg = new Ext.window.MessageBox();
    }
});
</pre>
</body>
</html>
