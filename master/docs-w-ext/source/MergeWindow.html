<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2017-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-window-MergeWindow'>/**
</span> * A window where the user can configure the merging of two layers.
 *
 * @class BasiGX.view.window.MergeWindow
 */
Ext.define(&#39;BasiGX.view.window.MergeWindow&#39;, {
    xtype: &#39;basigx-window-merge&#39;,
    extend: &#39;Ext.window.Window&#39;,
    requires: [
        &#39;BasiGX.util.Merge&#39;
    ],

<span id='BasiGX-view-window-MergeWindow-cfg-viewModel'>    viewModel: {
</span>        data: {
            adoptAttributes: &#39;Select attributes to add to the schema:&#39;,
            applyText: &#39;Apply&#39;,
            cancelText: &#39;Cancel&#39;,
            windowTitle: &#39;Merge features&#39;,
            matchText: &#39;Please select attributes to be mapped:&#39;
        }
    },

<span id='BasiGX-view-window-MergeWindow-cfg-bind'>    bind: {
</span>        title: &#39;{windowTitle}&#39;
    },

<span id='BasiGX-view-window-MergeWindow-cfg-layout'>    layout: &#39;fit&#39;,
</span><span id='BasiGX-view-window-MergeWindow-cfg-autoShow'>    autoShow: true,
</span><span id='BasiGX-view-window-MergeWindow-property-items'>    items: [],
</span><span id='BasiGX-view-window-MergeWindow-cfg-bodyPadding'>    bodyPadding: 5,
</span>
    config: {
<span id='BasiGX-view-window-MergeWindow-property-sourceLayer'>        /**
</span>         * The layer to merge.
         * @type {ol.layer.Vector}
         */
        sourceLayer: null,
<span id='BasiGX-view-window-MergeWindow-property-targetLayer'>        /**
</span>         * The layer to merge to.
         * @type {ol.layer.Vector}
         */
        targetLayer: null,
<span id='BasiGX-view-window-MergeWindow-property-extraTargetLayers'>        /**
</span>         * Optional extra layers to push the features into.
         * @type {ol.layer.Vector[]}
         */
        extraTargetLayers: null,
<span id='BasiGX-view-window-MergeWindow-property-mergedFeaturesFn'>        /**
</span>         * Optional callback function to get notified once the features have
         * been merged.
         * @type {Function} which will receive the features that have been
         * merged
         */
        mergedFeaturesFn: null
    },

<span id='BasiGX-view-window-MergeWindow-method-initComponent'>    initComponent: function() {
</span>        var me = this;
        me.callParent();
        me.mergeLayers();
        me.registerMultiSelectFilter();
        var combos = me.query(&#39;combo&#39;);
        Ext.each(combos, function(combo) {
            combo.on(&#39;change&#39;, function() {
                me.registerMultiSelectFilter();
            });
        });
    },

<span id='BasiGX-view-window-MergeWindow-method-registerMultiSelectFilter'>    registerMultiSelectFilter: function() {
</span>        var me = this;
        var store = this.down(&#39;multiselect&#39;).getStore();
        store.filterBy(function(rec) {
            var mappedFields = BasiGX.util.Merge.extractMappedFields(me);
            return mappedFields.indexOf(rec.data.field1) === -1;
        });
    },

<span id='BasiGX-view-window-MergeWindow-method-mergeLayers'>    /**
</span>     * Creates all the children.
     */
    mergeLayers: function() {
        var Merge = BasiGX.util.Merge;
        var sourceSchema = Merge.extractSchema(this.getSourceLayer());
        var targetSchema = Merge.extractSchema(this.getTargetLayer());

        var labels = [];
        var dropdowns = [];
        Ext.each(targetSchema, function(attr) {
            labels.push({
                xtype: &#39;label&#39;,
                margin: 3,
                text: attr
            });
            dropdowns.push({
                xtype: &#39;combo&#39;,
                store: sourceSchema,
                displayField: &#39;name&#39;,
                margin: 3,
                valueField: &#39;name&#39;,
                value: sourceSchema.includes(attr) ? attr : &#39;&#39;,
                allowBlank: true,
                forceSelection: true,
                editable: true
            });
        });

        this.createMergeWindow(labels, dropdowns, sourceSchema, targetSchema);
    },

<span id='BasiGX-view-window-MergeWindow-method-applyHandler'>    /**
</span>     * Callback that actually merges the two layers.
     * @param  {Array} origSchema  the original target layer origSchema
     * @return {Function}             the callback
     */
    applyHandler: function(origSchema) {
        var me = this;
        var Merge = BasiGX.util.Merge;
        return function() {
            var win = this.up(&#39;window&#39;);
            var newFeatures = me.getSourceLayer().getSource().getFeatures();
            var target = me.getTargetLayer().getSource();
            var mapping = Merge.extractMapping(win);
            var copy = Merge.extractToCopyAttributes(win);
            var extraLayers = me.getExtraTargetLayers() || [];
            var allFeatures = [];

            Ext.each(newFeatures, function(feature) {
                var newFeature = Merge.convertFeature(feature, mapping, copy,
                    origSchema);
                allFeatures.push(newFeature);
                target.addFeature(newFeature);
            });
            Ext.each(extraLayers, function(layer) {
                layer.getSource().addFeatures(allFeatures);
            });

            if (me.getMergedFeaturesFn()) {
                me.getMergedFeaturesFn()(allFeatures);
            }

            win.destroy();
        };
    },

<span id='BasiGX-view-window-MergeWindow-method-cancelHandler'>    /**
</span>     * Callback that just closes/destroys the merge window.
     */
    cancelHandler: function() {
        this.up(&#39;window&#39;).close();
    },

<span id='BasiGX-view-window-MergeWindow-method-createAttributeSelection'>    /**
</span>     * Create the multiselect used to select attributes to add.
     * @param  {Array} attributes the list of attributes
     * @return {Object}            the ext configuration object
     */
    createAttributeSelection: function(attributes) {
        return {
            xtype: &#39;multiselect&#39;,
            margin: 5,
            minHeight: 100,
            width: &#39;100%&#39;,
            bind: {
                fieldLabel: &#39;{adoptAttributes}&#39;
            },
            store: attributes
        };
    },

<span id='BasiGX-view-window-MergeWindow-method-createDropdownList'>    /**
</span>     * Creates the ext config for the label/dropdown vboxes for the merges
     * window.
     * @param  {Array} labels    the labels
     * @param  {Array} dropdowns the attributes list
     * @return {Array}           an array of vbox container configurations
     */
    createDropdownList: function(labels, dropdowns) {
        var vboxes = [];
        for (var i = 0; i &lt; labels.length; ++i) {
            vboxes.push({
                xtype: &#39;container&#39;,
                layout: &#39;vbox&#39;,
                margin: 3,
                items: [
                    labels[i],
                    dropdowns[i]
                ]
            });
        }
        return vboxes;
    },

<span id='BasiGX-view-window-MergeWindow-method-createMergeWindow'>    /**
</span>     * Creates and shows the merge window.
     * @param  {Array} labels       the original attributes label list
     * @param  {Array} dropdowns    the dropdowns with the source layer
     * attributes
     * @param  {Array} sourceSchema the source layer schema
     * @param  {Array} origSchema   the target layer schema
     */
    createMergeWindow: function(labels, dropdowns, sourceSchema, origSchema) {
        var vboxes = this.createDropdownList(labels, dropdowns);

        var buttons = {
            xtype: &#39;container&#39;,
            items: [{
                xtype: &#39;button&#39;,
                bind: {
                    text: &#39;{applyText}&#39;
                },
                margin: &#39;2 5 2 2&#39;,
                handler: this.applyHandler(origSchema)
            }, {
                xtype: &#39;button&#39;,
                bind: {
                    text: &#39;{cancelText}&#39;
                },
                margin: &#39;2 2 2 0&#39;,
                handler: this.cancelHandler
            }]
        };

        var attributeList = this.createAttributeSelection(sourceSchema);

        var panel = {
            xtype: &#39;form&#39;,
            layout: &#39;vbox&#39;,
            scrollable: true,
            width: 550,
            items: [{
                xtype: &#39;label&#39;,
                bind: {
                    text: &#39;{matchText}&#39;
                }
            }, {
                xtype: &#39;container&#39;,
                layout: {
                    type: &#39;table&#39;,
                    // The total column count must be specified here
                    columns: 3
                },
                items: vboxes
            },
            attributeList,
            {
                xtype: &#39;buttongroup&#39;,
                bodyBorder: false,
                frame: false,
                items: buttons
            }]
        };

        this.add(panel);
    }
});
</pre>
</body>
</html>
