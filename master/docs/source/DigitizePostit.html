<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2018-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-button-DigitizePostit'>/**
</span> * Digitize Postit Button
 *
 * @class BasiGX.view.button.DigitizePostit
 */
Ext.define(&#39;BasiGX.view.button.DigitizePostit&#39;, {
    extend: &#39;BasiGX.view.button.Base&#39;,
    xtype: &#39;basigx-button-digitize-postit&#39;,

    requires: [
        &#39;Ext.Loader&#39;,
        &#39;BasiGX.util.Digitize&#39;
    ],

<span id='BasiGX-view-button-DigitizePostit-property-viewModel'>    /**
</span>     *
     */
    viewModel: {
        data: {
            tooltip: &#39;Draw Post-it&#39;,
            drawPostItBtnText: &#39;Draw Post-it&#39;,
            postItWindowTitle: &#39;Enter the Post-its text&#39;,
            postItWindowCreatePostItBtnText: &#39;Create Post-it&#39;,
            postItInputTooLongText: &#39;The text you have entered is too long. &#39; +
                &#39;Do you want to continue anyway?&#39;
        }
    },

<span id='BasiGX-view-button-DigitizePostit-property-bind'>    /**
</span>     *
     */
    bind: {
        text: &#39;{drawPostItBtnText}&#39;
    },

    config: {
<span id='BasiGX-view-button-DigitizePostit-cfg-map'>        /**
</span>         * The OpenLayers map. Required.
         */
        map: null,

<span id='BasiGX-view-button-DigitizePostit-cfg-collection'>        /**
</span>         * The OpenLayers collection to work on. Required.
         */
        collection: null,

<span id='BasiGX-view-button-DigitizePostit-cfg-postitPictureUrl'>        /**
</span>         * The URL to a picture used for the postits.
         *
         * It is highly recommended that you set your own image source here
         */
        postitPictureUrl: null,

<span id='BasiGX-view-button-DigitizePostit-cfg-postitTextMaxLength'>        /**
</span>         * The maximum length of text allowed for the postit
         */
        postitTextMaxLength: 130,

<span id='BasiGX-view-button-DigitizePostit-cfg-drawPostitInteraction'>        /**
</span>         *
         */
        drawPostitInteraction: null
    },

<span id='BasiGX-view-button-DigitizePostit-property-name'>    name: &#39;postitbutton&#39;,
</span><span id='BasiGX-view-button-DigitizePostit-property-toggleGroup'>    toggleGroup: &#39;draw&#39;,
</span>
<span id='BasiGX-view-button-DigitizePostit-property-listeners'>    listeners: {
</span>        toggle: function(btn, pressed) {
            var me = this;
            if (!me.drawPostitInteraction) {
                var src = me.getPostitImgSrc();

                me.drawPostitInteraction = new ol.interaction.Draw({
                    features: new ol.Collection(),
                    type: &#39;Point&#39;,
                    style: new ol.style.Style({
                        image: new ol.style.Icon({
                            anchorXUnits: &#39;fraction&#39;,
                            anchorYUnits: &#39;pixels&#39;,
                            opacity: 0.75,
                            src: src
                        })
                    })
                });
                me.map.addInteraction(me.drawPostitInteraction);
            }
            if (pressed) {
                me.drawPostitInteraction.setActive(true);
                me.drawPostitInteraction.on(&#39;drawend&#39;,
                    me.setDefaultPostitStyle);
            } else {
                me.drawPostitInteraction.setActive(false);
                me.drawPostitInteraction.un(&#39;drawend&#39;,
                    me.setDefaultPostitStyle);
            }
        },
        beforedestroy: function() {
            if (this.drawPostitInteraction) {
                this.map.removeInteraction(this.drawPostitInteraction);
            }
        }
    },

<span id='BasiGX-view-button-DigitizePostit-method-constructor'>    /**
</span>     *
     */
    constructor: function() {
        var me = this;
        me.setDefaultPostitStyle = me.setDefaultPostitStyle.bind(this);
        me.callParent(arguments);
    },

<span id='BasiGX-view-button-DigitizePostit-method-getPostitImgSrc'>    /**
</span>     * Returns a usable image `src` for the postit; this will either be the
     * configured one (#postitPictureUrl), or it will be tried to be determined
     * from the path of the sourcefile of the redlining component itself (which
     * might be error-prone).
     *
     * The safest bet is to configure an explicit `postitPictureUrl`.
     *
     * @return {String} A image `src` for the postit image.
     */
    getPostitImgSrc: function() {
        if (this.getPostitPictureUrl() !== null) {
            return this.getPostitPictureUrl();
        } else {
            var classPath = Ext.Loader.getPath(
                &#39;BasiGX.view.button.DigitizePostit&#39;
            );
            var imageBaseSrc;
            if (classPath) {
                var devPath = &#39;src/view/button/DigitizePostit.js&#39;;
                if (classPath.indexOf(devPath) === -1) {
                    // we&#39;re on a production build, so let&#39;s use the
                    // image from the classic resource folder
                    imageBaseSrc = &#39;classic/&#39;;
                } else {
                    imageBaseSrc = classPath.split(devPath)[0];
                }
            }
            return imageBaseSrc + &#39;resources/img/postit.png&#39;;
        }
    },


<span id='BasiGX-view-button-DigitizePostit-method-setDefaultPostitStyle'>    /**
</span>     * Called after a postit is drawn, this will set a default postit style.
     *
     * @param {ol.interaction.Draw.Event} evt The `drawend`-event.
     */
    setDefaultPostitStyle: function(evt) {
        var me = this;
        var feature = evt.feature;
        if (feature) {
            feature.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchorXUnits: &#39;fraction&#39;,
                    anchorYUnits: &#39;pixels&#39;,
                    opacity: 0.75,
                    src: me.getPostitImgSrc()
                })
            }));
            var clone = evt.feature.clone();
            me.handlePostitAdd(clone);
        }
    },

<span id='BasiGX-view-button-DigitizePostit-method-handlePostitAdd'>    /**
</span>     * Handles adding of a new postit.
     *
     * @param {ol.Feature} feat The vector feature.
     * @param {String} oldText The old text of the postit.
     */
    handlePostitAdd: function(feat, oldText) {
        var me = this;

        feat.set(&#39;isPostit&#39;, true);

        BasiGX.prompt(me.getViewModel().get(&#39;postItWindowTitle&#39;), {
            fn: function(decision, text) {
                if (decision === &#39;cancel&#39;) {
                    me.collection.remove(feat);
                } else {
                    if (text.length &gt; me.postitTextMaxLength) {
                        BasiGX.confirm(me.getViewModel().get(
                            &#39;postItInputTooLongText&#39;), {
                            fn: function(choice) {
                                if (choice === &#39;yes&#39;) {
                                    text = BasiGX.util.Digitize.
                                        stringDivider(text, 16, &#39;\n&#39;);
                                    me.setPostitStyleAndTextOnFeature(
                                        text, feat);
                                } else {
                                    me.handlePostitAdd(feat, text);
                                }
                            }
                        });
                    } else {
                        text = BasiGX.util.Digitize.
                            stringDivider(text, 16, &#39;\n&#39;);
                        me.setPostitStyleAndTextOnFeature(text, feat);
                    }
                }
            },
            multiline: 150,
            value: oldText
        });

        var button = Ext.ComponentQuery.query(&#39;button[name=postitbutton]&#39;)[0];
        button.toggle(false);
    },

<span id='BasiGX-view-button-DigitizePostit-method-setPostitStyleAndTextOnFeature'>    /**
</span>     * Sets a postit style and text on a feature.
     *
     * @param {String} text The text of the postit.
     * @param {ol.Feature} feat The vector feature.
     */
    setPostitStyleAndTextOnFeature: function(text, feat) {
        var me = this;
        feat.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
                anchorXUnits: &#39;fraction&#39;,
                anchorYUnits: &#39;pixels&#39;,
                opacity: 0.75,
                src: me.getPostitImgSrc()
            }),
            text: new ol.style.Text({
                text: text,
                scale: 1.5,
                offsetY: 80
            })
        }));
        me.collection.push(feat);
    }
});
</pre>
</body>
</html>
