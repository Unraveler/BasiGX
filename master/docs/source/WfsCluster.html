<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2015-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-plugin-WfsCluster'>/**
</span> * Plugin used for server-side clustering (e.g. with a GeoServer SQL-View), and
 * client-side styling.
 *
 * @class BasiGX.plugin.WfsCluster
 */
Ext.define(&#39;BasiGX.plugin.WfsCluster&#39;, {
    extend: &#39;Ext.plugin.Abstract&#39;,

    alias: &#39;plugin.wfscluster&#39;,
<span id='BasiGX-plugin-WfsCluster-property-pluginId'>    pluginId: &#39;wfscluster&#39;,
</span>
<span id='BasiGX-plugin-WfsCluster-method-init'>    init: function(cmp) {
</span>        var me = this;
        me.setCmp(cmp);

        me.setUpClusterLayers(me.getCmp());
    },

<span id='BasiGX-plugin-WfsCluster-method-setUpClusterLayers'>    setUpClusterLayers: function(mapComponent) {
</span>        var me = this;
        var map = mapComponent.getMap();
        var allLayers = BasiGX.util.Layer.getAllLayers(map);
        var clusterLayers = [];

        Ext.each(allLayers, function(layer) {
            if (layer.get(&#39;type&#39;) === &#39;WFSCluster&#39;) {
                // register visibility listener to load the features when
                // layer is toggled in tree, which is not detected by the
                // maps moveend listener
                // TODO: check why this gets fired 2 times -&gt; geoext?!!
                if (!layer.visibilityListener) {
                    layer.on(&#39;change:visible&#39;, function(evt) {
                        if (evt.target.getVisible()) {
                            me.loadClusterFeatures(layer);
                        }
                    });
                }
                clusterLayers.push(layer);
                if (layer.get(&#39;olStyle&#39;)) {
                    layer.setStyle(layer.get(&#39;olStyle&#39;));
                } else {
                    layer.setStyle(me.clusterStyleFunction);
                }
            }
        });

        if (clusterLayers.length &gt; 0) {
            // on every map move
            map.on(&#39;moveend&#39;, function() {
                me.loadClusterFeatures(clusterLayers);
            });
        }
    },

<span id='BasiGX-plugin-WfsCluster-method-clusterStyleFunction'>    clusterStyleFunction: function(feature) {
</span>        var layerName;
        if (feature.getId()) {
            layerName = feature.getId().split(&#39;.&#39;)[0];
        } else {
            layerName = feature.get(&#39;layerName&#39;);
        }

        var layer = BasiGX.util.Layer.getLayerByName(layerName);
        var count = feature.get(&#39;count&#39;);
        var radius;
        var fontSize;

        if (count &gt; 10) {
            radius = 25;
            fontSize = 14;
        } else if (count &lt; 4) {
            fontSize = 7;
            radius = 8;
        } else {
            radius = count * 2;
            fontSize = count * 1.3;
        }
        return [
            new ol.style.Style({
                image: new ol.style.Circle({
                    radius: radius,
                    // opacity: 0.6,
                    fill: new ol.style.Fill({
                        color: layer.get(&#39;clusterColorString&#39;)
                    }),
                    stroke: new ol.style.Stroke({
                        color: &#39;gray&#39;
                    })
                }),
                text: new ol.style.Text({
                    text: count &gt; 1 ? count.toString() : &#39;&#39;,
                    font: &#39;bold &#39; + fontSize * 2 + &#39;px Arial&#39;,
                    stroke: new ol.style.Stroke({
                        color: &#39;black&#39;,
                        width: 1
                    }),
                    fill: new ol.style.Fill({color: &#39;white&#39;})
                })
            })
        ];
    },

<span id='BasiGX-plugin-WfsCluster-method-loadClusterFeatures'>    /**
</span>     * The wfscluster layerType expects a geoserver view which handles
     * clustering with database methods.
     *
     * @param {Array&lt;ol.layer.Vector&gt;} clusterLayers The layers to cluster.
     */
    loadClusterFeatures: function(clusterLayers) {
        var me = this;
        var mapComponent = me.getCmp();
        var map = mapComponent.getMap();

        if (map &amp;&amp; map.getView() &amp;&amp; map.getView().getResolution() &amp;&amp;
            map.getSize()) {
            var res = map.getView().getResolution();
            var extent = map.getView().calculateExtent(map.getSize());
            // the factor which describes the distance used
            // to decide when to cluster. Unit is very
            // roughly ~meters.
            var factor = Math.round(res * 70);

            // when reaching the lower limit of 250, reduce /
            // disable clustering to see the real features
            if (factor &lt; 250) {
                factor = 1;
            }
            Ext.each(clusterLayers, function(layer) {
                if (layer.getVisible()) {
                    var featureType = layer.get(&#39;featureType&#39;);
                    var baseUrl = layer.get(&#39;url&#39;);
                    Ext.Ajax.request({
                        url: baseUrl + &#39;?service=WFS&amp;&#39; +
                            &#39;version=1.0.0&amp;&#39; +
                            &#39;request=GetFeature&amp;&#39; +
                            &#39;typeName=&#39; + featureType + &#39;&amp;&#39; +
                            // TODO portability, e.g. UMN mapserver might have
                            // sth. else (if at allâ€¦)
                            &#39;outputFormat=application/json&amp;&#39; +
                            &#39;bbox=&#39; + extent.join(&#39;,&#39;) + &#39;&amp;&#39; +
                            &#39;viewParams=resolutioninm:&#39; + factor + &#39;;&#39; +
                            &#39;bboxllx:&#39; + extent[0] + &#39;;&#39; +
                            &#39;bboxlly:&#39; + extent[1] + &#39;;&#39; +
                            &#39;bboxurx:&#39; + extent[2] + &#39;;&#39; +
                            &#39;bboxury:&#39; + extent[3],
                        success: function(response) {
                            var feats = response.responseText;
                            var f = new ol.format.GeoJSON().readFeatures(feats);
                            layer.getSource().clear();
                            layer.getSource().addFeatures(f);
                        },
                        failure: function() {
                            var msg = &#39;Failure on load of cluster features&#39;;
                            Ext.log.error(msg);
                        }
                    });
                }
            });
        }
    }
});
</pre>
</body>
</html>
